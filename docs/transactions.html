<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易記錄</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="brand">
                <div class="logo">POS</div>
                <div class="brand-text">
                <div class="brand-title">POS 系統</div>
                <div class="brand-sub">交易記錄</div>
                </div>
            </div>
            <div class="nav-links">
                <a href="index.html">銷售頁</a>
                <a href="transactions.html" class="active">交易記錄</a>
                <a href="products.html">產品管理</a>
                <button id="resetSeedBtn" class="action-btn" style="margin-left:12px">重設範例資料</button>
            </div>
        </div>

        <div class="card">
            <h1>交易記錄</h1>

            <div class="filter-bar">
                <input type="text" id="qInput" placeholder="搜尋交易 ID 或產品名稱">
                <input type="date" id="fromDate">
                <input type="date" id="toDate">
                <select id="perPage">
                    <option value="10">每頁 10</option>
                    <option value="25">每頁 25</option>
                    <option value="50">每頁 50</option>
                </select>
                <button id="applyFilters" class="btn">套用</button>
                <button id="clearFilters" class="btn ghost">清除</button>
                <button id="exportCsv" class="btn export-btn">匯出 CSV</button>
            </div>

            <div class="stats-row">
                <div class="stat"><div class="muted">交易總數</div><div id="statTotalTx">-</div></div>
                <div class="stat"><div class="muted">總營收</div><div id="statTotalRevenue">-</div></div>
                <div class="stat"><div class="muted">最近交易</div><div id="statLastTx">-</div></div>
            </div>

            <div id="txList" class="transaction-list"></div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="txModal" class="modal-backdrop" style="display:none">
        <div class="modal" role="dialog" aria-modal="true">
            <button class="close-btn" id="closeModal">✕</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer" aria-live="polite"></div>

    <script>window.__API_URL__ = 'https://pos-lb9c.onrender.com';</script>
    <script src="transactionViewer.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', ()=>{
    const apiBase = (window.__API_URL__ || 'http://127.0.0.1:5001') + '/api';
    const btn = document.getElementById('resetSeedBtn');
    if(!btn) return;
    btn.addEventListener('click', ()=>{
        console.log('[transactions] resetSeedBtn clicked');
        if(!confirm('確定要清除並重新建立範例資料嗎？這會建立資料表（如尚未建立）並刪除所有交易與產品資料。')) return;
        btn.disabled = true;
        const initUrl = apiBase + '/init_db';
        const resetUrl = apiBase + '/reset_seed';
        console.log('[transactions] calling init:', initUrl);
        fetch(initUrl, { method: 'POST' })
            .then(initRes => {
                console.log('[transactions] init status:', initRes.status);
                return fetch(resetUrl, { method: 'POST' });
            })
            .then(async r => {
                console.log('[transactions] reset status:', r.status);
                btn.disabled = false;
                if(!r.ok){ const err = await r.text().catch(()=>'<no-body>'); console.error('[transactions] reset body:', err); throw new Error('重設失敗'); }
                try{ const data = await r.json(); console.log('[transactions] reset body:', data);}catch(e){}
                if(typeof showToast === 'function') showToast('已初始化並重設範例資料', 'success');
                else alert('已初始化並重設範例資料');
                setTimeout(()=> location.reload(), 700);
            }).catch(err=>{ console.error('[transactions] error:', err); btn.disabled = false; if(typeof showToast === 'function') showToast('初始化或重設失敗','error'); else alert('初始化或重設失敗'); });
    });
});
</script>
</body>
</html>
