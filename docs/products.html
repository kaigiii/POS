<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>產品管理</title>
	<link rel="stylesheet" href="styles.css">
	<link rel="icon" href="data:;base64,=" />
</head>
<body>
	<div class="container">
		<div class="navbar">
			<div class="brand">
				<div class="logo">POS</div>
				<div class="brand-text">
					<div class="brand-title">POS 系統</div>
					<div class="brand-sub">產品管理</div>
				</div>
			</div>
			<button id="navToggle" class="hamburger" aria-label="開啟選單">☰</button>
			<div class="nav-links">
				<a href="index.html">銷售頁</a>
				<a href="transactions.html">交易記錄</a>
				<a href="products.html" class="active">產品管理</a>
				<button id="resetSeedBtn" class="action-btn" style="margin-left:12px">重設範例資料</button>
			</div>
		</div>

		<div class="card">
			<h1>產品管理</h1>
			<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
				<div>
					<div class="muted">總商品</div>
					<div id="statTotalProducts" style="font-weight:700;font-size:18px">-</div>
				</div>
				<div>
					<div class="muted">總庫存</div>
					<div id="statTotalStock" style="font-weight:700;font-size:18px">-</div>
				</div>
			</div>
			<form id="addProductForm" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
				<input type="text" name="name" placeholder="產品名稱" required>
				<input type="number" name="price" placeholder="售價" step="0.01" required>
				<input type="number" name="cost" placeholder="成本" step="0.01" required>
				<input type="number" name="stock" placeholder="庫存" min="0" value="0">
				<button type="submit" class="btn">新增產品</button>
			</form>
		</div>

		<div class="card">
			<div style="display:flex;justify-content:space-between;align-items:center">
				<h2 style="margin:0">商品清單</h2>
				<div class="muted">顯示為表格或卡片</div>
			</div>
			<div id="productGrid" class="product-grid" aria-live="polite"></div>
			<table style="display:none" id="productTable">
				<thead>
					<tr>
						<th>ID</th>
						<th>名稱</th>
						<th>售價</th>
						<th>成本</th>
						<th>庫存</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody id="productTableBody">
					<!-- 產品列表將動態生成 -->
				</tbody>
			</table>
			<!-- 編輯產品模態 -->
			<div id="editModal" class="modal-backdrop" style="display:none;">
				<div class="modal" style="max-width:520px;width:100%">
					<div class="modal-header">
						<h3>編輯產品</h3>
						<button id="editClose" class="action-btn">關閉</button>
					</div>
					<form id="editProductForm">
						<input type="hidden" id="edit_id" />
						<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
							<label>名稱<input id="edit_name" required /></label>
							<label>價格<input id="edit_price" type="number" step="0.01" required /></label>
							<label>成本<input id="edit_cost" type="number" step="0.01" required /></label>
							<label>庫存<input id="edit_stock" type="number" step="1" required /></label>
						</div>
						<div style="margin-top:12px;text-align:right">
							<button type="button" class="action-btn" id="editCancel" onclick="closeEditModal()">取消</button>
							<button type="submit" class="action-btn">儲存變更</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	<div class="toast-container" id="toastContainer" aria-live="polite"></div>
	<script>window.__API_URL__ = 'https://pos-lb9c.onrender.com';</script>
	<script src="nav.js"></script>
	<script src="productManager.js"></script>
	<script>
document.addEventListener('DOMContentLoaded', ()=>{
	const apiBase = (window.__API_URL__ || 'http://127.0.0.1:5001') + '/api';
	const btn = document.getElementById('resetSeedBtn');
	if(!btn) return;
	btn.addEventListener('click', ()=>{
		console.log('[products] resetSeedBtn clicked');
		if(!confirm('確定要清除並重新建立範例資料嗎？這會建立資料表（如尚未建立）並刪除所有交易與產品資料。')) return;
		btn.disabled = true;
		const initUrl = apiBase + '/init_db';
		const resetUrl = apiBase + '/reset_seed';
		console.log('[products] calling init:', initUrl);
		fetch(initUrl, { method: 'POST' })
			.then(initRes => {
				console.log('[products] init status:', initRes.status);
				if(!initRes.ok) {
					return initRes.text().then(text => {
						console.error('[products] init failed body:', text);
						throw new Error(`Init failed: ${initRes.status}`);
					});
				}
				return initRes.json();
			})
			.then(initData => {
				console.log('[products] init response:', initData);
				console.log('[products] calling reset:', resetUrl);
				return fetch(resetUrl, { method: 'POST' });
			})
			.then(async r => {
				console.log('[products] reset status:', r.status);
				if(!r.ok){ 
					const err = await r.text().catch(()=>'<no-body>'); 
					console.error('[products] reset body:', err); 
					throw new Error('重設失敗'); 
				}
				try{ 
					const data = await r.json(); 
					console.log('[products] reset body:', data);
				} catch(e) {
					console.error('[products] parse json error:', e);
				}
				btn.disabled = false;
				if(typeof showToast === 'function') showToast('已初始化並重設範例資料（此操作可能需要一些時間才能完成，請稍後刷新頁面）', 'success');
				else alert('已初始化並重設範例資料。此操作可能需要一些時間才能完成，請稍後刷新頁面。');
				setTimeout(()=> location.reload(), 700);
			})
			.catch(err => { 
				console.error('[products] error:', err); 
				console.error('[products] error stack:', err.stack);
				btn.disabled = false; 
				if(typeof showToast === 'function') showToast('初始化或重設失敗: ' + err.message + '（若為延遲造成，請稍後再試）', 'error'); 
				else alert('初始化或重設失敗: ' + err.message + '；若為延遲造成，請稍後再試'); 
			});
	});
});
</script>
</body>
</html>
